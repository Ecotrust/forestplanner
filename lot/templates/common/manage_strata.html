{% extends 'common/base.html' %}
{% load url from future %}

{% block content %}


<div class="row-fluid">

    <ul class="nav nav-tabs" id="global-tabs">
        <li>
            <a data-bind="attr: { href: '/#properties/' + app.strata.property_id }">
                <span class="tab-num">1</span>
                Properties<span style="display:none" data-bind="visible: app.strata.property_name !== '' ">: </span>
                <span class="property-name" data-bind="text: app.strata.property_name"></span>
            </a>
        </li>
        <li>
            <a data-bind="attr: { href: '/#stands/' + app.strata.property_id }">
                <span class="tab-num">2</span>
                Define Stand Boundaries</a>
        </li>
        <li class="active">
            <a>
                <span class="tab-num">3</span>
                Define Forest Types</a>
        </li>
        <li>
            <a data-bind="attr: { href: '/#scenarios/' + app.strata.property_id }">
                <span class="tab-num">4</span>
                Evaluate Future Scenarios</a>
        </li>
        <!--
                //  @TODO app.properties.viewModel.selectedProperty() doesn't exist yet. Will need to
                apply bindings to the tabs in a callback. doing it on doc.ready for now.
                or ko.observable set when this is ready
                <li data-bind="css: {active: app.state('scenarios') }"><a href="#scenarios" data-bind="
                    css: {disabled: app.properties.viewModel.selectedProperty().stand_summary.with_condition() <
                    app.properties.viewModel.selectedProperty().stand_summary.total()}">Evaluate Future Scenarios</a></li>
                    -->
    </ul>
    <div id="help-collapse" class="accordion-body collapse">
      <div class="accordion-inner well">
        <button type="button" class="close" data-toggle='collapse' href='#help-collapse' aria-hidden="true">&times;</button>
        <div data-bind="html: app.helpText"></div>
        <div class="pull-right" id="hide-help"><a data-toggle='collapse' href='#help-collapse'>Hide Help</a></div>
      </div>
    </div>
</div>


<div data-bind="if: !activeStratum()">
    <div class="row-fluid">

        <div class="span5">
      <!--<h2> Define Forest Types </h2>-->

      <div class="row-fluid btn-bar clearfix" data-bind="visible: !app.strata.property_is_locked">

        <img src="/media/common/img/info-icon.png" class="pull-right definition-icon" title="Forest types describe the composition of one or more of your stands, including the age, species, diameter classes, and number of trees per acre. Each forest type may be applied to one or more stands."></i>

        <button class="btn btn-success pull-right" data-bind="click: createStratum"><i class="icon-plus icon-white"></i>
            New Forest Type</button>
      </div>

                  <div class="btn-bar clearfix" data-bind="visible: app.strata.property_is_locked">
                    <div class="well" style="font-size:85%; font-style:italic;">
                      <i class="icon-warning-sign"></i>
                      This property's stands are linked to custom forest
                      inventory data and cannot be edited
                    </div>
                  </div>

            <div class="well">

                <!-- strata list -->
                <div class="row-fluid">
                    <div class="span12" data-bind="visible: strataList().length && ! activeStratum()" style="display: none" >

                        <div class="row-fluid">
                                <p>You have applied forest types to <span data-bind="text: appliedStrataTotal"></span> of <span
                                    data-bind="text: standTotal"></span> stands.</p>
                                <div class="progress">
                                    <div class="bar bar-success" data-bind="style: { width: (appliedStrataTotal()/standTotal)*100+'%' }"></div>
                                </div>

                                <p class="help-inline" data-bind="if: appliedStrataTotal() !== standTotal">
                                        To apply a forest type to a stand, select a stand on the map and click the &ldquo;apply&rdquo; button on the
                                        associated forest type. You can select multiple stands simply by clicking.
                                </p>


                                <div class="next-button-wrap" data-bind="if: appliedStrataTotal() == standTotal">
                                        <a class="btn btn-primary btn-large" data-bind="attr: { href: '/#scenarios/' + app.strata.property_id }">
                    <strong>Next</strong>: Evaluate Future Scenarios for
                    <strong><em data-bind="text: app.strata.property_name"></em></strong>
                    <i class="icon-arrow-right"></i>
                  </a>
                                </div>

                        </div>

                        <div class="row-fluid">
                            <div class="form-inline">
                                    <label for="filter-stand-group">Filter Forest Types</label>
                                    <input id="filter-stand-group" type="text" class="search-query" placeholder="Search" data-bind="value: searchTerm, valueUpdate: 'keyup'">
                                    <button class="btn btn-mini" data-bind="visible: searchTerm, click: clearStandFilter ">Clear Filter</button>
                            </div>
                        </div>

                        <div class="row-fluid strata-list" data-bind="foreach: filteredStrataList()">
                            <div class="stratum-box" data-bind="attr: { 'data-color': color(), 'data-sid': attributes.uid }, style: { 'background': color() }, event: { mouseleave: function () { confirmDelete(false) } }">
                                <div class="row-fluid">
                                    <div class="span5">
                                        <h4><span data-bind="text: attributes.name"></span></h4>
                                    </div>
                                    <div class="span7">
                                        <dl class="dl-horizontal">
                                            <dt>Trees Per Acre:</dt>
                                            <dd data-bind="text: attributes.search_tpa"></dd>
                                            <dt>Stand Age:</dt>
                                            <dd data-bind="text: attributes.search_age"></dd>
                                            <dt class="show-trees" data-bind="visible: !app.strata.property_is_locked, click: toggleTrees,
                                                text: showTrees() ? '- Hide Trees' : '+ Show Trees'"></dt>
                                            <dd class="dd-treelist" data-bind=" visible: showTrees">
                                                <ul class="unstyled tree-list" data-bind="foreach: standList">
                                                    <li data-bind="visible: species">
                                                    <span data-bind="text: sizeClass"></span>
                                                    <span data-bind="text: species"></span>
                                                    (<span data-bind="text: tpa"></span> tpa)
                                                    </li>
                                                </ul>
                                            </dd>
                                        </dl>
                                    </div>
                                    </div>

                                <div class="veg-type-btns" data-bind="visible: confirmDelete">
                                    <p class="sure">Are you sure?</p>
                                    <!--<p>Delete this forest type?</p> too long! -->
                                    <div class="btn-group">
                                        <button class="btn btn-mini" data-bind="click: function () { confirmDelete(false) }">cancel</button>
                                        <button class="btn btn-mini btn-danger" data-bind="click: deleteStratum">delete</button>
                                    </div>
                                </div>

                                <div class="btn-group veg-type-btns" data-bind="visible: confirmDelete() === false && !app.strata.property_is_locked">
                                    <button class="btn btn-mini" title="Apply this forest type to any selected stands" data-bind="click: $parent.applyStrata">apply</button>
                                    <button class="btn btn-mini" title="Edit this forest type" data-bind="click: $parent.editStratum">edit</button>
                                    <button class="btn btn-mini" title="Delete this forest type" data-bind="click: function () { confirmDelete(true) }"><i class="icon-remove"></i></button>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>

                <!-- property has no strata -->
                <div data-bind="visible: !strataList().length && ! activeStratum()" style="display: none">
                    You have not yet defined any forest types. You can <a data-bind="click: createStratum">add one now</a>.
                </div>

            </div><!-- /.well -->



        </div>

        <div class="span7">
            <div class="outermap well"> <!-- map_wrapper"> -->
                <!--
                HAVING A TOUGH TIME GETTING THIS TO WORK.
                SHOWS UP BUT DOES NOT SYNC WITH MAP!

                <a id="legend-button" data-toggle="collapse" data-target="#legend-list">
                  <i class="icon-align-justify icon-white" style="margin-top: 2px;"></i>
                </a>
                <div id="legend-container">
                    <div class="clearfix"></div>
                    <div id="legend-list" class="collapse">
                      <div class="well">
                        <div style="opacity:1.0;" id="not-a-layerswitcher"></div>
                        <div id="legend"></div>
                      </div>
                    </div>
                    <div class="clearfix"></div>
                </div>
                -->
                <div id="map"></div>
            </div>
        </div>

    </div>
</div><!-- /!activeStratum() -->




<!-- ======================= Edit Stand Group ================== -->

<div class="edit-stand-group" data-bind="if: activeStratum()" >
    <div class="row-fluid">

        <div class="span12">
            <div class="well">

                <div data-bind="visible: activeStratum()" style="display: none">

                    <!--
                    <div data-bind="visible: !activeStratum().standList().length"  style="display: none">
                        <h2>Enter Stand Group Information</h2>
                        <p>We should have some help text here.</p>
                    </div>
                    -->

                    <div>

                        <div data-bind="with: activeStratum" class="row-fluid">

                            <div class="span6">
                                <div>
                                    <h2 data-bind="visible: !editMode()">Create a Forest Type</h2>
                                    <h2 data-bind="visible: editMode()">Editing Forest Type: <i data-bind="text: attributes.name"></i></h2>
                                    <label>Name Your Forest Type</label>
                                    <input type="text" class="span8" placeholder="Name" autofocus data-bind="value: attributes.name, valueUpdate: 'keyup'"/>
                                    <div class="row-fluid">
                                        <!--
                                            <p data-bind="text: totalTpa()"></p>
                                        <div class="span4">
                                            <label>Trees Per Acre</label>
                                            <input type="text" class="input-mini" data-bind="value: attributes.search_tpa, valueUpdate: 'keyup'">
                                        </div>
                                        -->
                                        <div class="span4">
                                            <label>Stand Age (in years)</label>
                                            <input type="text" class="input-mini" data-bind="value: attributes.search_age, valueUpdate: 'keyup'">
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- /.span5 -->

                            <div class="span6">
                                <div id="chart-container"></div>
                            </div>

                     </div> <!-- /.row-fluid /with: activeStratum -->

           <div class="alert-error well" style="font-weight: bold; white-space: pre-wrap"
             data-bind="visible: vegetationTypeError(), text: vegetationTypeError"></div>

           <div data-bind="with: activeStratum" class="row-fluid">
             <table class="table table-bordered stand-table">

                             <thead>
                 <tr>
                   <th class="species-col">Species</th>
                   <th class="size-class-col">Size Class</th>
                                     <th class="percentage-col">Density <br />(trees per acre)</th>
                   <th class="tpa-col">Percentage</th>
                   <th class="actions-col"></th>
                 </tr>
                             </thead>

                             <tbody>

                                 <!-- ko foreach: displayStandList -->
                                 <tr data-bind="visible: !isEditing()">
                                     <td>
                                         <span data-bind=" text: species"></span>
                                     </td>
                                     <td>
                                         <span data-bind=" text: sizeClass"></span>
                                     </td>
                                         <td>
                                         <span data-bind="text: tpa"></span>
                                     </td>
                                     <td>
                                         <!-- ko if: percentage() / percentage() == 1 -->
                                         <span data-bind="text: percentage() + '%'"></span>
                                         <!-- /ko -->
                                     </td>
                                     <!--
                                     <td>
                                         <span data-bind="
                                             visible: $parent.attributes.search_tpa(),
                                             text: (percentage()/100*$root.activeStratum().attributes.search_tpa()).toFixed(0)"></span>
                                     </td>
                                    -->
                                     <td>
                                         <div class="btn-group" data-bind="visible: speciesConfirmDelete() === false">
                                             <button class="btn btn-mini btn-primary" data-bind="click: editTree">Edit</button>
                                             <button class="btn btn-mini" data-bind="click: function () { speciesConfirmDelete(true) } ">Delete</button>
                                         </div>
                                         <div data-bind="visible: speciesConfirmDelete">
                                             <p class="sure">Are you sure?</p>
                                             <div class="btn-group">
                                                 <button class="btn btn-mini" data-bind="click: function () { speciesConfirmDelete(false) } ">Cancel</button>
                                                 <button class="btn btn-mini btn-danger" data-bind="click:  $parent.removeSpecies">Delete</button>
                                                </div>
                                         </div>
                                     </td>
                                 </tr>


                                 <tr data-bind="visible: isEditing()">
                                     <td>
                                         <span>
                                             <label class="accessibility">Select a Species <br> <span data-bind="text: species"></span></label>
                                             <select style="width: 95%" data-bind="options: app.strata.treeSpecies, value: species,
                                                 select2: {placeholder: 'Add a Species',  speciesData: species()}" >
                                             </select>
                                         </span>
                                     </td>
                                     <td>
                                         <span><select style="width: 90%" data-bind="options: sizeClasses, value: sizeClass, select2:
                                                 {placeholder: '' }"></select></span>
                                     </td>
                                     <!--
                                     <td>
                                         <div class="row-fluid">
                                             <label class="accessibility">Percentage of Stand</label>
                                             <input name="percentage" class="input-mini span3"
                                                data-bind="value: percentage,
                                                valueUpdate: 'keyup',
                                                css:{error: !percentageIsValid() }"
                                                /> %
                                             <div class="help-inline alert-error" data-bind="visible: !percentageIsValid(), text:
                                                 percentageIsValidMsg() "></div>
                                         </div>
                                     </td>
                                    -->
                                        <td>
                                             <label class="accessibility">Trees per Acre</label>
                                             <input name="tpa" class="input-mini span3"
                                                data-bind="value: tpa, valueUpdate: 'keyup' "
                                                />
                                        </td>
                                     <td>
                                         <!--
                                         <span data-bind="
                                             visible: $parent.attributes.search_tpa(),
                                             text: (percentage()/100*$root.activeStratum().attributes.search_tpa()).toFixed(0)"></span>%
                                             -->
                                     </td>
                                     <td>
                                         <span> <!-- /click:updateTree, -->
                                             <button class="btn btn-mini btn-success disabled" data-bind="click: $parent.saveTreee,
                                                    css: {
                                                    'enabled': species().length && !isNaN(parseFloat( tpa() )),
                                                    'disabled': !species().length || isNaN(parseFloat( tpa() ))
                                                    },
                                                    enable: species().length && !isNaN(parseFloat( tpa() ))" >
                                                    Save Species
                                                </button>
                                         </span>
                                     </td>
                                 </tr>
                                 <!-- /ko -->


                             </tbody>

                         </table>
                     </div> <!-- /.row-fluid /with: activeStratum -->


                     <!-- data-bind="with: activeStratum" ::::: enable:app.strata.viewModel.activeStratum().canSave() -->
                         <div  class="btn-group pull-right">
                             <button class="btn btn-large" data-bind="click: cancel">cancel</button>
                             <button class="btn btn-large btn-success" id="btn-save-strata"
                                 data-bind="click: saveStrata">
                                 <i class="icon-check icon-white"></i> Save Forest Type</button>
                         </div>
                         <div class="clearfix"></div>

                 </div><!--  -->

             </div> <!-- / visible: activeStratum -->

         </div> <!-- /.well -->
     </div> <!-- /.span12 -->

    </div> <!-- /.row-fluid -->
</div> <!-- /.edit-stand-group -->

<!-- ======================= /End Edit Stand Group ================== -->









                <!--</div> [> /if activeStratum <]-->

      <!-- end partial -->

{% endblock content %}
{% block scripts %}
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/jquery.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/json2.js"></script> <!-- for the benefit of older IEs -->
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/jquery.form.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout-2.1.0.js"></script>
    <!--<script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout-2.2.1.debug.js"></script>-->
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout.mapping-latest.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/knockout-custom-bindings.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/select2.js"></script>

    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-carousel.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-button.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-transition.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>

    <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="{{MEDIA_URL}}/jqplot/excanvas.js"></script><![endif]-->
    <!-- <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script> -->
    <script src="{{ MEDIA_URL }}OpenLayers.js"></script>
    {% load compressed %}
    <style>
      h1 {
        margin-bottom: 10px;
      }

      #chart-container {
        height: 300px;
        width: 100%;
      }
        .stand-table tr.active,
        .table tbody tr:hover td, .table tbody tr:hover th {
          background-color: inherit;

        }

                .stand-table th {
                    width: 10%;
                }
                    .stand-table .species-col{
                        width: 25%;
                    }
                    .stand-table .tpa-col{
                        width: 10%;
                    }
        .stand-table tr.active {
            font-weight: bold;
        }
        #map {
            height: 500px;
        }
        .map_wrapper {
          position: relative;
        }
        .map_wrapper .btn {
          position: absolute;
          left: 15px;
          bottom: 15px;
          z-index: 2000;
        }

        .strata-list {
          z-index: 2000;
          margin-top: 10px;
          height: 400px;
          overflow-y: auto;

        }
          .strata-list .stratum-box {
            border: 1px solid #aaa;
            // padding: 5px 5% 0;
            padding: 0 5% 0;
            position: relative;
                  width: 86%;

            /*border-radius: 10px;
            margin: 10px;
            width: 40%;
            /*height: 100px;
            float: left;
            z-index: 2000;*/

          }
              .stratum-box + .stratum-box       { border-top: none; }
              .strata-list .stratum-box:hover   { border: 1px solid #444; }
              .stratum-box + .stratum-box:hover { margin-top: -1px; }
        .stratum-box .alert-error{
          background-color: #f2f2f2;
          border: 1px solid #DD5240;
          color: #DD5240;
          border-radius: 3px;
          padding: 2px 5px 5px 6px;
          max-width: 60%;
          text-align: center;
        }
          .strata-list .stratum-box h4 {
                   /*
                   max-width: 65%;
              font-size: 16px;
              margin-left: -5px;
              margin-bottom: 10px;
              text-overflow: ellipsis;
              overflow: hidden;
              white-space: nowrap;
                  */
          }
          .strata-list .stratum-box .row-fluid{
              font-size: 80%;
          }
          .strata-list .stratum-box p { /* no more */
            line-height: 5px;
                        margin-bottom: 5px;
          }
          .strata-list .stratum-box .dl-horizontal dd,
            .strata-list .stratum-box .dl-horizontal dt{
                float: left;
                width: auto;
                line-height: 1.4;
                margin-left: 5px;
          }
            .strata-list .show-trees:hover {
                cursor: pointer;
            }
          .strata-list .stratum-box .dl-horizontal dt{
              clear: both;
                margin-left: 0;
          }
          .strata-list .stratum-box.ui-draggable-dragging .btn {
            opacity: 0;
          }
          .strata-list .veg-type-btns {
            opacity: 0;
            position: absolute;
            right: 10px;
            top: 10px;
          }
                    .strata-list .veg-type-btns p{
                        font-size: 0.9em;
                        margin-bottom: 8px;
                        text-align: center;
                    }
          .strata-list .stratum-box:hover .veg-type-btns {
            opacity: .8;
          }
          .strata-list .stratum-box dl {
            //margin-top: -6px;
                        margin-bottom: 13px;
          }
          .strata-list .stratum-box .tree-list li {
            /* margin-left: 5px; */
          }
          .dl-horizontal dt {
            text-align: left;
          }
                    .dd-treelist {
                        clear: both;
                    }
          .span6 .alert-error{
            margin-bottom: 10px;
            padding: 5px;
          }
            .progress+.help-inline, .next-button-wrap{
                margin-top: -1em;
                margin-bottom: 2em;
            }
      .scenario-row dl {
        margin-top: 0px;
      }
          #filter-stand-group {
              width: 40%;
          }
    </style>
    <script type="text/javascript">
        var madrona = {
            onShow: function (callback) {
                callback();
                //madrona.formCallbacks.push(callback);
            },
            formCallbacks: [],
            features: {}
        };

        var app = {
            stands: {},
            scenarios: {},
            properties: {}
        };




        {% if user.is_authenticated %}
        $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
            app.workspace = data;
        });
        {% else %}
        $.get('/features/workspace-public.json', function (data) {
            app.workspace = data;
        });
        {% endif %}

        app.helpText = ko.observable();
        $.get('/trees/intro.html', function(text){
            app.helpText($(text).find('#intro-vegetation')[0].outerHTML);
        });

        // call array.cycle(x) to extend the array to x elements
        // by cycling through. if x < length, return original array
        Array.prototype.cycle = function(val){
            var l = this.length;
            if(l < val){
                for(var i = val-1-l; i >= 0; i--){
                    this[i+l] = this[i % l];
                }
            }
            return this;
        };

        var colorRamp = ['D8E2A7','DA9C90','D2A379','CCC266','ADD071','6AC247','339936','267373','349D7F','449FC1','6A86CD','7971D0','AB81D5','C79FDF','EBC6EC'];
        colorRamp = colorRamp.cycle(50); // support up to 50 forest types

        // to go into strata.js
        app.strata = {
            property_id: "{{ property_id }}",
            property_name: "{{ property_name }}",
            property_is_locked: {% if property_is_locked %}true{% else %}false{% endif %},
            color: colorRamp,
            treeSpecies : ko.observableArray(),
            sizeClasses : []
        };

        app.strata.colorMap = {};
        app.strata.init = function () {
            app.strata.viewModel = new strataViewModel();

            $.each(app.strata.data, function (i, strata) {
              app.strata.viewModel.strataList.push(new stratumViewModel(strata));
            });

            ko.applyBindings(app.strata.viewModel);

            // add controls, save references
            app.selectFeature = new OpenLayers.Control.SelectFeature(app.stand_layer, {
                    "clickout": false,
                    "multiple": true,
                    "toggle": true,
                    //styling here to ensure selecting stands
                    // with strata applied appear selected.
                    "selectStyle": map_styles.strataSelect //defined in styles.js
            });

            map.render('map');
            map.updateSize();
            map.zoomToExtent(app.property_layer.getDataExtent());

            $('.info-help').find('strong')
                .next('span').hide()
                .after('<span class="read-more"> Read More...</span>');

            $('.info-help .read-more').on('click', function () {
                var $t = $(this);
                // console.log('$t clicked', $t);
                $t.prev('span').toggle();
                $t.closest('.info-help').toggleClass('opened');
                if ($t.prev('span').is(':visible')) {
                    $t.text(' Read Less');
                } else {
                    $t.text(' Read More...');
                }
            });

            // reenable click and drag in vectors
            map.addControl(app.selectFeature);
            app.selectFeature.activate();
        };

        // individual stand list member
        function standViewModel (stratum, options) {
            var self = this, chartTimer = null;
            if (! options) {
              options = [];
            }
            // reference to the parent stratum
            self.stratum = stratum;

            // stand characteristics
            self.species = ko.observable(options[0]);
            self.tpa = ko.observable('22');
            if (options[1] && options[2]) {
              self.sizeClass = ko.observable([options[1] + '"', options[2] + '"'].join(' to '));
            } else {
              self.sizeClass = ko.observable();
            }

            if (options[3]) {
              self.tpa = ko.observable(parseInt(options[3], 10));
            } else {
              self.tpa = ko.observable();
            }
            //self.percentage = ko.observable(  );

            self.percentage = ko.computed(function () {
                var self = this;
                return Math.ceil(( (self.tpa() / self.stratum.totalTpa()) * 100).toFixed(0));
            }, self);

            self.percentageIsValid = ko.observable(true);
            self.percentageIsValidMsg = ko.observable('');

            self.index = ko.computed(function () {
                var self = this;
                return stratum.standList.indexOf(this);
            }, self);

            self.updateChart = function () {
              // delay the chart update for a bit
              if (chartTimer) {
                clearTimeout(chartTimer);
              }
              chartTimer = setTimeout(function () {
                app.strata.chartStandList(self.stratum.displayStandList());
              }, 500);
            };

            self.isEditing = ko.observable(false);
            self.speciesConfirmDelete = ko.observable(false);
            self.editTree = function (event) {
                this.isEditing(true);
            };

            self.updateTree = function (task) {
                //create the new model and push to standList here?
                this.isEditing(false);
                app.strata.viewModel.activeStratum().recalculateDisplayStandList.notifySubscribers();
            };

            self.sizeClasses = ko.computed(function() {
                    var pos = app.strata.treeSpecies().indexOf(self.species());
                    return app.strata.sizeClasses[pos-1];
            }, self);

            self.percentage.subscribe(self.updateChart);
            self.species.subscribe(self.updateChart);
            self.sizeClass.subscribe(self.updateChart);

            return self;
        };


        // viewmodel for a single stratum (aka Forest Type)
        function stratumViewModel (options) {
            var self = {};

            if (! options) {
                options = {};
            }
            // console.dir(options);
            self.attributes = {
                // feature attributes from madrona
                name: ko.observable(options.name),
                search_tpa: ko.observable(options.search_tpa),
                search_age: ko.observable(options.search_age),
                additional_desc: ko.observable(options.additional_desc),
                stand_list: ko.observable(options.stand_list),
                uid: options.uid
            };

            // viewmodel attributes
            self.color = ko.observable();
            self.currentStand = ko.observable();
            self.confirmDelete = ko.observable(false);
            self.editMode = ko.observable(false);
            self.editTrees = ko.observable(false);

            self.standList = ko.observableArray();

            self.species = ko.observable();
            self.sizeClass = ko.observable();
            self.percentage = ko.observable();
            self.tpa = ko.observable();

            self.totalTpa = ko.computed(function(){
                var totalTpa = 0;

                $.each(self.standList(), function(i, stand){
                    // console.info('stand.tpa()', stand.tpa());
                    totalTpa += parseInt(stand.tpa(), 10);
                });
                return totalTpa;
            });

            self.saveTreee = function (tree, event, bar) {
                if(tree){
                    tree.isEditing(false);
                    self.standList.remove(tree);
                    self.standList.push(tree);
                    app.strata.viewModel.activeStratum().recalculateDisplayStandList.notifySubscribers();
                }
            };

            self.showTrees = ko.observable(false);

            self.toggleTrees =  function(){
                 self.showTrees(!self.showTrees());
            };

            self.totalPercentage = ko.computed(function(){
                var totalPercentage = 0;

                $.each(self.standList(), function(i, stand){
                    totalPercentage += parseInt(stand.percentage(), 10);
                });
                return totalPercentage;
            });

            // basic validation setup. More @TODO
            // check for numbers, display errors...
            self.canSave = ko.computed(function(){
                var canSave = true;

                if ( !self.attributes.name() ) {
                    canSave = false;
                }
                if ( !self.attributes.search_age() ) {
                    canSave = false;
                }

                return canSave;
            });

            self.recalculateDisplayStandList = ko.observable();


            // display a computed standlist with a dummy last item
            // to show the remaining percentage
            // called on keyup when model changes at all
            self.displayStandList = ko.computed(function () {
                var displayStandList = [], totalPercentage = 0, msg;

                // cheap hax. When saving a standlist member,
                // we ping recalculateDisplayStandList so displayStandlist
                // updates itself. without it, we don't get the
                // remaining % species placeholder added again.
                self.recalculateDisplayStandList();

                $.each(self.standList(), function (i, stand) {
                    displayStandList.push(stand);
                });

                if ( app.strata.viewModel.activeStratum() &&
                    (app.strata.viewModel.activeStratum().attributes.name() == self.attributes.name())){
                    // species name, sizeclass lower bound, upper bound, percentage
                    var placeHolder = new standViewModel(self,
                    //[ 'Unknown type', "?", "?", 100 - totalPercentage ]);
                    [ 'Unknown type', "?", "?", 0 ]);

                    placeHolder.isEditing(true);

                    displayStandList.push(placeHolder);

                    if( app.strata.viewModel.activeStratum().attributes.uid == self.attributes.uid ){
                        // self.standList.push(placeHolder);
                    }
                }

                return displayStandList;
            });


            if (options.stand_list) {
              $.each(options.stand_list.classes || JSON.parse(options.stand_list).classes, function (i, stand) {

                // console.warn('pushed new standViewModel from options.stand_list');
                self.standList.push(new standViewModel(self, stand));
              });
            }

            // set the color and store a reference
            if (self.attributes.uid != undefined && app.strata.colorMap[self.attributes.uid]) {
                self.color(app.strata.colorMap[self.attributes.uid]);
            } else {
                self.color('#' + app.strata.color.reverse().pop());
                app.strata.colorMap[self.attributes.uid] = self.color(); //TODO: app.strata.colorMap['undefined'] is being set. This should probably be fixed
            }

            // initial stand coloring
            $.each(app.stand_layer.features, function(i, stand) {
                // @TODO: if you have 10 strata and 15 stands, this is running 150 times.
                // better way?
                if (stand.attributes.strata !== null && stand.attributes.strata.uid === self.attributes.uid) {
                    stand.style = {
                        fillColor: self.color(),
                        fillOpacity: '.6',
                        strokeColor: '#fff'
                    };
                    app.stand_layer.drawFeature(stand);
                    app.strata.viewModel.setAppliedStrataTotal();
                }
            });

            self.deleteStratum = function(stratum) {
                app.strata.deleteStratum(stratum.attributes.uid, function() {
                    app.strata.viewModel.strataList.remove(stratum);
                    self.clearStands(stratum.attributes.uid);
                });
            };


            //when a stratum is deleted, make sure we clear the existing stands on the map as well
            self.clearStands = function(uid) {
                $.each(app.stand_layer.features, function(i, feature) {
                    // is it a stand assigned to the deleted stratum?
                    if (feature.attributes.strata !== null && feature.attributes.strata.uid === uid) {
                        //clear and apply
                        feature.style = {
                            fillColor: 'Transparent',
                            fillOpacity: '.6',
                            strokeColor: '#fff'
                        };
                        feature.attributes.strata = null;
                        feature.data.strata = null;
                        app.stand_layer.drawFeature(feature);

                        //hey count, pay attention.
                        app.strata.viewModel.setAppliedStrataTotal();
                    }
                });
            };

            self.addSpecies = function(stand, event) {
                var stand,
                    self = this,
                    attrs = [],
                    sizes;

                //sizes = '24" to 36"' - remove quotes and split
                sizes = self.sizeClass().replace(/(")/g, "").split(" to ");

                // 139% sure there is a better way.
                attrs[0] = self.species();
                attrs[1] = sizes[0];
                attrs[2] = sizes[1];
                attrs[3] = self.percentage();

                stand = new standViewModel(self, attrs);

                self.species('');
                self.percentage('');

                self.standList.push(stand);

                console.warn('pushed new standViewModel from self.addSpecies');
                self.currentStand(stand);
                self.currentStand().updateChart();
            };


            self.removeSpecies = function(stand) {
                self.standList.remove(stand);
            };


            self.sizeClasses = ko.computed(function() {
                var pos = app.strata.treeSpecies().indexOf(self.species());
                return app.strata.sizeClasses[pos - 1];
            }, self);


            ko.bindingHandlers.select2 = {
                init: function(element, valueAccessor, allBindingsAccessor) {
                    var obj = valueAccessor(),
                        allBindings = allBindingsAccessor(),
                        lookupKey = allBindings.lookupKey;

                    $(element).select2(obj);

                    if (lookupKey) {
                        var value = ko.utils.unwrapObservable(allBindings.value);
                        $(element).select2('data', ko.utils.arrayFirst(obj.data.results, function(item) {
                            return item[lookupKey] === value;
                        }));
                    }

                    ko.utils.domNodeDisposal.addDisposeCallback(element, function() {
                        $(element).select2('destroy');
                    });
                },
                update: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
                    //$(element).trigger('change');

                    if (!self.currentStand()) {
                        var stand = new standViewModel(self);
                        self.currentStand(stand);
                    }


                }
            };

            // console.dir(self.standList());

            return self;
            };




            function strataViewModel() {
                var self = {};

                // filter term for strata
                self.searchTerm = ko.observable();
                // list of strata
                self.strataList = ko.observableArray();
                self.vegetationTypeError = ko.observable(null);
                self.standTotal = app.stand_layer.features.length;

                // n of Y stands applied
                self.appliedStrataTotal = ko.observable(0);
                self.setAppliedStrataTotal = function() {
                    var total = 0;

                    $.each(app.stand_layer.features, function(i, stand) {
                        if (stand.attributes.strata !== null) {
                            total = total + 1;
                        }
                    });
                    self.appliedStrataTotal(total);

                };

                // either false, or holds a stratumViewModel
                self.activeStratum = ko.observable();

                // the species lists needs an empty string at the beggining
                self.treeSpecies = app.strata.treeSpecies;
                self.treeSpecies.unshift('');

                // strata list that is actually displayed on the page
                // filtered by searchTerm
                self.filteredStrataList = ko.computed(function() {
                    var strataList = this,
                        filteredStrataList = [],
                        searchTerm;

                    if (self.searchTerm()) {
                        searchTerm = self.searchTerm().toLowerCase();

                        // filter the strata list
                        $.each(strataList(), function(i, strata) {

                            // if (strata.attributes.name().toLowerCase().indexOf(searchTerm) !== -1 || strata.attributes.stand_list().toLowerCase().indexOf(searchTerm) !== -1) {
                            if (strata.attributes.name().toLowerCase().indexOf(searchTerm) !== -1) {
                                filteredStrataList.push(strata);
                            }
                        });
                    } else {
                        filteredStrataList = strataList();
                    }
                    return filteredStrataList;
                }, self.strataList);

                self.clearStandFilter = function() {
                    self.searchTerm("");
                };

                self.activeStratum.subscribe(function(activeStratum) {

                    if (activeStratum && activeStratum.standList().length) {
                        app.strata.chartStandList(activeStratum.displayStandList());
                    } else { // no active stratum, so set cached chart data to null
                        app.strata.chartData = null;
                    }

                });

                self.strataList.subscribe(function() {
                    self.setAppliedStrataTotal();
                });

                self.rubberBandActive = ko.observable(false);

                app.selectFeature = new OpenLayers.Control.SelectFeature(app.stand_layer, {
                    "clickout": false,
                    "multiple": true,
                    "toggle": true,
                    "selectStyle": map_styles.strataSelect
                });

                app.selectFeatureBox = new OpenLayers.Control.SelectFeature(app.stand_layer, {
                    "clickout": false,
                    "multiple": true,
                    "toggle": true,
                    "box": true,
                    "selectStyle": map_styles.strataShiftSelect
                });

                $(document).on('keydown', function(e) {
                    if (e.shiftKey && !self.rubberBandActive()) {
                        self.rubberBandActive(true);
                        app.selectFeature.deactivate();
                        app.selectFeatureBox.activate();
                    }
                });

                $(document).on('keyup', function(e) {
                    if (self.rubberBandActive()) {
                        self.rubberBandActive(false);
                        app.selectFeatureBox.deactivate();
                        app.selectFeature.activate();
                    }
                });

                map.addControl(app.selectFeature);
                map.addControl(app.selectFeatureBox);

                self.editStratum = function(stratum) {
                    // var duplicateStratum = new stratumViewModel(ko.toJS(stratum.attributes));
                    // duplicateStratum.editMode(true);
                    // self.activeStratum(duplicateStratum);
                    app.strata.stratumBeingEdited = stratum;
                    stratum.editMode(true);
                    self.activeStratum(stratum);
                    window.location.hash = 'edit-vegetation-type';
                };

                self.cancel = function() {
                    self.activeStratum(null);
                    self.vegetationTypeError(null);
                    map.render('map');
                };

                self.createStratum = function() {
                    console.warn('createStratum');
                    self.activeStratum(new stratumViewModel());
                };

                self.applyStrata = function(stratum) {
                    // can be called from the draggable/droppable
                    // switching to the knockout binding for now
                    var stand_uid_list = [],
                        color = stratum.color(),
                        stratum_id = stratum.attributes.uid;

                    // get strata id, if knockout stratum will be this

                    // Do we have a strata selected?
                    // @TODO more KO, less JQ
                    if (!app.stand_layer.selectedFeatures.length) {

                        var msg = "Please select a stand on your map to apply this forest type.",
                            $t;

                        // little clean up because DOM stuff is silly
                        $('.stratum-box .alert-error').remove();

                        // add and remove a temporary warning
                        $('[data-sid="' + stratum_id + '"]').prepend('<div class="alert-error">' + msg + '</div>')
                            .find('.alert-error').each(function() {
                                $t = $(this);
                                window.setTimeout(function() {
                                    $t.fadeOut(1300, function() {
                                        $t.remove();
                                    });
                                }, 5000);
                            });

                        return;
                    }

                    // apply strata to selected stands
                    $.each(app.stand_layer.selectedFeatures, function(i, feature) {
                        // don't count features already counted
                        if (!feature.attributes.strata) {
                            // var currentTotal = self.appliedStrataTotal();
                            // self.appliedStrataTotal(currentTotal+1);
                        }
                        feature.style = {
                            fillColor: color,
                            fillOpacity: '.6',
                            strokeColor: '#fff'
                        };
                        feature.attributes.strata = ko.mapping.toJS(stratum.attributes);
                        feature.data.strata = ko.mapping.toJS(stratum.attributes);

                        app.stand_layer.drawFeature(feature);
                        stand_uid_list.push(feature.attributes.uid);
                    });

                    app.strata.applyStrataToStand(stratum_id, stand_uid_list);
                    app.selectFeature.unselectAll();
                    self.setAppliedStrataTotal();
                };

                self.updateStratum = function(oldStratum, activeStratum) {
                    console.warn('updateStratum');
                    self.strataList.replace(oldStratum, new stratumViewModel(activeStratum));
                };


                self.saveStrata = function(data, event) {


                    var self = this,
                        postData,
                        stratum = app.strata.viewModel.activeStratum(),
                        url = "/features/strata/form/",
                        $target = $(event.target),
                        $targetText = $target.text();


                    if (!stratum.canSave()) {
                        self.vegetationTypeError("Please include a name and age for this Forest Type.");
                        return;
                    }

                    $target.addClass('loading').text('Saving. One moment...');

                    self.vegetationTypeError(null);

                    if (stratum.editMode()) {
                        url = "/features/strata/{uid}/".replace('{uid}', stratum.attributes.uid);
                    }

                    stratum.attributes.search_tpa(stratum.totalTpa());
                    postData = ko.mapping.toJS(stratum.attributes);

                    postData.stand_list = ko.toJSON({
                        'property': app.strata.property_id,
                        'classes': $.map(stratum.standList(), function(stand) {
                            var sizes = [];

                            if (stand.species() && stand.sizeClass() && stand.tpa()) {
                                sizes = stand.sizeClass().replace(/(")/g, "").split(" to ");

                                return [
                                    [
                                        stand.species(),
                                        parseInt(sizes[0], 10),
                                        parseInt(sizes[1], 10),
                                        parseInt(stand.tpa())
                                    ]
                                ];
                            }
                        })
                    });

                    $.ajax({
                        url: url,
                        type: "post",
                        traditional: true,
                        datatype: 'json',
                        data: postData,
                        success: function(response) {

                            if (typeof(response) == "string") {
                                response = jQuery.parseJSON(response);
                            }

                            var strata_uid = response["X-Madrona-Select"];

                            if (stratum.editMode()) {
                                // existing strata
                                self.updateStratum(app.strata.stratumBeingEdited, postData);
                            } else {
                                // new strata
                                app.strata.associateStandWithProperty(app.strata.property_uid, strata_uid);
                                self.activeStratum().attributes.stand_list = postData.stand_list;
                                self.activeStratum().attributes.uid = strata_uid;
                                self.strataList.push(self.activeStratum());
                            }
                            self.activeStratum(null);
                            self.vegetationTypeError(null);
                            map.render('map');


                        },
                        error: function(response) {
                            var msg = "";
                            if (response.status == 400) {
                                //@TODO er, ko. -wm
                                msg = "We were unable to find a representative plot for your inventory. please verify ";
                                msg += "the species and size classes you've entered. if everything looks ok, ";
                                msg += "please try to remove any minor species or diameter classes from your list. ";
                                msg += "\n\n" + "The Forest Planner is in active development - ";
                                msg += "please let us know if we can help via the about page above.";
                                self.vegetationTypeError(msg);
                            } else {
                                msg = "we're sorry, something has gone wrong with saving your forest type; please check your work and try again. ";
                                msg += "\n\n" + "if you continue to have trouble ";
                                msg += "saving your forest type, please contact us with this error code: " + response.status;
                                msg += " via the about page above. thank you.";
                                self.vegetationTypeError(msg);
                            }
                        },
                        complete: function() {
                            $target.removeClass('loading').text($targetText);
                        }

                    });
                };

                return self;
            }



            app.strata.deleteStratum = function(strata_uid, cb) {
                var url = "/features/generic-links/links/delete/{strata_uid}/".replace('{strata_uid}', strata_uid);

                return $.ajax({
                    url: url,
                    type: "DELETE",
                    traditional: true,
                    success: function(response) {
                        cb();
                    },
                    error: function(response) {
                        console.log(response);
                    }
                });
            };

            app.strata.applyStrataToStand = function(strata_uid, stand_uid_list) {
                var url = "/features/strata/links/add-stands/{strata_uid}/".replace('{strata_uid}', strata_uid);

                return $.ajax({
                    url: url,
                    type: "POST",
                    data: {
                        'stands': stand_uid_list.join()
                    },
                    traditional: true,
                    success: function(response) {

                    },
                    error: function(response) {

                    }
                });
            };

            app.strata.associateStandWithProperty = function(property_uid, strata_uid) {
                var url = "/features/forestproperty/{property_uid}/add/{strata_uid}";

                url = url.replace('{property_uid}', app.strata.property_id);
                url = url.replace('{strata_uid}', strata_uid);

                return $.ajax({
                    url: url,
                    type: "POST",
                    traditional: true,
                    success: function(response) {

                    },
                    error: function(response) {

                    }
                });
            };


            $.when(
                $.getJSON("/features/forestproperty/links/property-strata-list/" + app.strata.property_id + '/', function(data) {
                    app.strata.data = data;
                }),

                //get the actual available species
                $.getJSON("/trees/variant/" + app.strata.property_id + "/species_sizecls.json", function(data) {
                    //should probably be done server side.
                    data.sort(function(a, b) {
                        if (a.species < b.species) return -1;
                        if (a.species > b.species) return 1;
                        return 0;
                    });
                    $.each(data, function(i, tree) {
                        var sizes = $.map(tree.size_classes, function(a, i) {
                            //return [[a.min, a.max]];
                            return a.min.toString() + '" to ' + a.max.toString() + '"';
                        });
                        app.strata.treeSpecies.push(tree.species);
                        app.strata.sizeClasses.push(sizes);
                    });
                }),

                $.get('/features/generic-links/links/geojson/{uid}/'.replace('{uid}', app.strata.property_id), function(data) {
                    app.property_layer.addFeatures(app.geojson_format.read(data));

                }),
                $.get('/features/forestproperty/links/property-stands-geojson/{property_id}/'.replace('{property_id}', app.strata.property_id), function(data) {
                    //var styleMap = map_styles.stand;
                    app.stand_layer = new OpenLayers.Layer.Vector("Stands", {
                        styleMap: map_styles.stand,
                        renderers: app.renderer
                    });

                    app.stand_layer.styleMap.default = new OpenLayers.Style({
                        fillColor: "blue",
                    }, {
                        // Rules go here.
                        context: {}
                    });
                    map.addLayer(app.stand_layer);
                    app.stand_layer.addFeatures(app.geojson_format.read(data));
                })
            ).then(function() {
                app.strata.init();
            });




            // charting stuff
            app.strata.chartData = null;
            app.strata.chartTimer = null;

            app.strata.chartStandList = function(standList) {
                var chart, chartData, chartDataUpdated = true;
                if (app.strata.chartTimer) {

                }
                chartData = $.map(standList, function(stand) {
                    var sizeClass = stand.sizeClass() ? (' ' + stand.sizeClass()) : null;
                    if (stand.percentage()) {
                        return [
                            [
                                stand.species() + ' ' + sizeClass,
                                parseInt(stand.percentage(), 10)
                            ]
                        ];
                    }
                });
                // check to see if data has been udpated
                if (app.strata.chartData && ko.toJSON(chartData) === ko.toJSON(app.strata.chartData)) {
                    chartDataUpdated = false;
                }
                if (chartDataUpdated && app.strata.viewModel.activeStratum()) {
                    setTimeout(function() {
                        app.strata.chartData = chartData;
                        chart = new Highcharts.Chart({
                            chart: {
                                renderTo: 'chart-container',
                                plotBackgroundColor: null,
                                plotBorderWidth: null,
                                plotShadow: false,
                                backgroundColor: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                text: 'Species Breakdown',
                                css: {
                                    fontFamily: 'Helvetica,Arial,sans-serif'
                                }
                            },
                            credits: false,
                            tooltip: {
                                pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>',
                                percentageddDecimals: 1,
                                valueDecimals: 2
                            },
                            plotOptions: {
                                pie: {
                                    allowPointSelect: true,
                                    cursor: 'pointer',
                                    dataLabels: {
                                        enabled: false,
                                        color: '#000000',
                                        connectorColor: '#000000',
                                        formatter: function() {
                                            return '<b>' + this.point.name + '</b>: ' + (this.percentage).toFixed(0) + ' %';
                                        }
                                    }
                                }
                            },
                            series: [{
                                type: 'pie',
                                name: 'Percentage',
                                data: chartData
                            }]

                        });
                    }, 300);
                }
            };

    </script>
    <script type="text/javascript" src="{{MEDIA_URL}}features/js/workspace.js"></script>

    {% compressed_js 'application' %}

    <script src="{{ MEDIA_URL }}common/js/hash_routing.js"></script>
    <script src="{{ MEDIA_URL }}common/js/strata.js"></script>
    <script src="{{ MEDIA_URL }}common/js/breadcrumbs.js"></script>
{% endblock scripts %}





