{% extends 'common/base.html' %}
{% load url from future %}

{% block content %}
   <!-- this should go into a partial -->
      <!--
      <div class="row-fluid">
        <div class="span5">
          <div><h1>Manage Properties</h1></div>
        </div>
        <div class="span7">
          <span class="pull-right">
            {% include "common/geosearch.html" %}
          </span>
        </div>
      </div>
      -->
        <div class="row-fluid">
          <div class="span6">
            <ul id="breadcrumbs" class="breadcrumb" data-bind="foreach: breadcrumbs">
              <li data-bind="visible: ! $parent.isLast($data)">
                <a data-bind="text: name, click: action"></a>
                  <span class="divider">/</span>
              </li>
              <li class="active" data-bind="visible: $parent.isLast($data)">
                <span data-bind="text: name"></span>
              </li>
            </ul>
            <!-- these are all property pages -->
            {% if user.is_authenticated %}
            <div id="property-html" class="well" data-bind="visible: showPropertyPanels" > <!-- need to make this a different color -->
               <div class="modal" id="delete-dialog" style="display:none">
                <div class="modal-header">
                  <a class="close" data-dismiss="modal">×</a>
                  <h3>Delete Property</h3>
                </div>
                <div class="modal-body">
                  <div data-bind="if: selectedProperty()">
                    Are you sure you want to delete "<span data-bind="text: selectedProperty().name"></span>"?
                  </div>
                </div>
                <div class="modal-footer">
                  <a href="#" class="btn" data-bind="click: closeDialog">cancel</a>
                  <a href="#" class="btn btn-danger" data-bind="click: deleteFeature">Delete Property</a>
                </div>
              </div>
              <div class="row-fluid" data-bind="if: showNoPropertiesHelp">
                <h2>Create Properties</h2>
                <p><em>You currently have no properties under management.</em></p>
                <div id="properties-none">
                  <h3>Draw your property</h3>
                  <p>Find your properties on the map by searching for a placename or parcel id.</p>
                  <div>
                      <form class="form-search">
                          <input type="text" class="input-large search-query" placeholder="placename or parcel id">
                          <button class="btn" type="submit">Search</button>
                      </form>
                  </div>
                  <p>When your property is in view on the map, click the button below to draw the boundaries of your first property.</p>
                  <h3>Add additional information</h3>
                  <p>Then you will be asked to enter some additional information to help describe your property.</p>
                  <div class="pull-right">
                    <button href="#" class="btn btn-large btn-primary" data-bind="click: startAddDrawing, disable: preventUpdates">Add Property</button>
                  </div>
                </div> <!-- no properties -->
              </div><!-- end of no properties -->
              <div>
                <div id="properties-list" style="display: none" data-bind="if: propertyList().length, visible: showPropertyList">
                  <h2>Property List</h2>
                  <p>
                  <div class="btn-group">
                      <button href="#" class="btn" data-bind="click: startAddDrawing, disable: preventUpdates">
                          <i class="icon-plus-sign"></i> Add Property</button>
                      <button class="btn" href="#" data-bind="click: zoomToExtent, disable: preventUpdates">
                          <i class="icon-resize-full"></i> Show All Properties</button>
                      <button href="#" class="btn" data-bind="click: startUpload, disable: preventUpdates">
                          <i class="icon-upload"></i> Upload</a>
                  </div>
                  </p>
                  <div class="row-fluid" style="display:none"  data-bind="visible: propertyList().length">
                    <table class="table table-condensed table-bordered table-hover">
                      <thead><th>Name</th><th>Area (acres)</th><th>County</th></thead>
                      <tbody data-bind="foreach: propertyList">
                        <tr data-bind="click: $parent.selectProperty, css: { active: $data === $parent.selectedProperty() }">
                          <td><a data-bind="text: name"></a></td>
                          <td><span data-bind="text: acres"></span></td>
                          <td><span data-bind="text: location"></span></td>           
                        </tr>
                      </tbody>
                    </table>
                    <div class="pull-right">
                    </div>
                  </div>
                </div><!-- has properties -->
                <div class="row-fluid"><!-- panels -->
                  <div>
                    <div style="display:none" data-bind="visible: showUploadPanel">
                      <h2>Upload stands</h2>
                      <p> File upload </p>
                      <ul> 
                          <li> A .zip file containing an ESRI Shapefile </li>
                          <li> Projected to Web Mercator </li>
                          <li> Contains polygons of all stands </li>
                          <li> Must contain an string attribute field called "name" </li>
                      </ul>
                      <div class="well">
                      <form id="uploadForm" action="{% url 'trees-upload_stands' %}" method="post" enctype="multipart/form-data"> 
                            <input type="hidden" name="MAX_FILE_SIZE" value="100000">
                            <p> 
                                <label for="upload-propertyname">
                                    <span id="upload-propertyname-required" class="label label-important"
                                        style="display:none;"> 
                                        Required 
                                        <i class="icon-exclamation-sign icon-white"></i> 
                                    </span>
                                    &nbsp; New Property Name
                                </label>
                                <input type="text" id="upload-propertyname" name="new_property_name" size="10"/>
                            </p>
                            <p> 
                                <span id="upload-file-required" class="label label-important"
                                    style="display:none;"> 
                                    Required 
                                    <i class="icon-exclamation-sign icon-white"></i> 
                                </span>
                                <input type="file" id="upload-file" name="ogrfile" size="10"/> 
                                <input id="uploadbutton" type="submit" class="btn btn-primary" value="Upload"/>
                            </p>
                            <div class="pull-right">
                                <a href="#" class="btn" data-bind="click: cancelUpload">cancel</a>
                            </div>
                      </form>
                      <div id="uploadProgress" style="display: none; width:80%;" class="progress progress-striped active">
                        <div class="bar" style="width: 0%;"></div>
                      </div>
                      <div id="uploadResponse" style="width: 80%; font-size: 125%;"></div>
                      </div>
                    </div>
                    <div style="display:none" data-bind="if: showDrawHelpPanel, visible: showDrawHelpPanel">
                      <h2>Draw Property Boundary</h2>
                      <p> Double-click to complete polygon. </p>
                      <div class="pull-right">
                        <a href="#" class="btn" data-bind="click: cancelEdit">cancel</a>
                      </div>
                    </div>
                    <div style="display: none;" class="hero-unit property-details" data-bind="if: showDetailPanel, visible: showDetailPanel">
                        <h3>Property Details</h3>
                        <table class="table table-condensed table-bordered" data-bind="if: selectedProperty()">
                            <tr><td>Property Name</td><td><strong><span data-bind="text: selectedProperty().name"><span><strong></td></tr>
                          <tr><td>Area</td><td><span data-bind="text: selectedProperty().acres()"></span> acres</td></tr>
                          <tr><td>County</td><td><span data-bind="text: selectedProperty().location"></span></td></tr>
                        </table>
                        <div class="pull-right btn-group">
                          <button href="#" id="delete-button" class="btn" 
                              data-bind="click: showDeleteDialog"><i class="icon-remove"></i> Delete Property</button>
                          <button class="btn" href="#" 
                              data-bind="click: showEditForm, disable: preventUpdates">
                              <i class="icon-edit"></i> Edit Property</button>
                          <button class="btn" href="#"><i class="icon-repeat"></i> Define Scenarios</button>
                          <button class="btn" href="#" 
                              data-bind="click: manageStands"><i class="icon-adjust"></i> Setup Stands</button>
                        </div>
                      </div>
                    </div>
                    <div class="form-panel" style="display: none" data-bind="if: showEditPanel, visible: showEditPanel">
                      <h2>Edit Property</h2>
                      <div id="edit-panel"></div>
                      <div class="pull-right" id="edit-panel-buttons">
                        <a href="#" class="btn" data-bind="click: cancelEdit">cancel</a>
                        <a href="#" class="btn btn-primary" data-bind="click: updateFeature">save changes</a>
                      </div>
                    </div>
                    <div class="form-panel" style="display:none" data-bind="if: showCreatePanel, visible: showCreatePanel">
                      <h2>Create Property</h2>
                      <div id="create-panel"></div>
                      <div class="pull-right" id="create-panel-buttons">
                        <a href="#" class="btn" data-bind="click: cancelEdit">cancel</a>
                        <a href="#" class="btn btn-primary" data-bind="click: addFeature">create</a>
                      </div>
                    </div>
                  </div>
              </div>
            </div>

            <!-- end of property pages -->

            <!-- these are all stand pages -->
            <div id="stand-html" class="well" style="display: none" data-bind="visible: showStandPanels, if: showStandPanels">
              <div class="row-fluid">
                <div data-bind="visible: showStandList">
                  <div class="progress progress-striped active" data-bind="visible: showProgressBar">
                    <div class="bar" data-bind="style: { width: progressBarWidth() }"></div>
                  </div>
                  <p data-bind="visible: ! standList().length"><em>You currently have no stands under management.</em></p>
                  <div data-bind="if: standList().length > 0">
                  <div class="row-fluid">
                    <div class="span3">
                      <h3>Stand List</h3>

                      <p>
                        <div class="btn-group">
                            <a href="#" class="btn" data-bind="click: addStandStart"><i class="icon-plus-sign"></i> Add</a>
                        </div>
                      </p>
                      <div>
                          <ul class="nav nav-tabs nav-stacked" data-bind="foreach: standListPaginated">
                            <li data-bind="click: $parent.selectFeature, css: { active: $data === $parent.selectedFeature() }">
                                <a href="#" data-bind="text: name"></a>
                            </li>
                        </ul>
                      </div>
                    </div>
                    <div class="span9" data-bind="if: selectedFeature">
                      <h3>Stand Details</h3>
                      <div class="stand-detail" data-bind="with: selectedFeature">
                        <table class="table">
                          <tr>
                            <td>Name</td><td data-bind="text: name"></td>
                          </tr>
                          <tr>
                            <td>Calculated Area</td><td><span data-bind="text: acres"></span> acres</td>
                          </tr>
                        </table>

                        <h4>Terrain</h4>
                        <table class="table table-condensed">
                        <tr><td>Aspect</td><td data-bind="text: aspect"></td></tr>
                        <tr><td>Slope</td><td data-bind="text: slope">something</td></tr>
                        <tr><td>Elevation</td><td><span data-bind="text: elevation"></span> m</td></tr>
                        </table>

                        <h4>Vegetation</h4>
                        <div class="row-fluid vegetation">
                          <div class="span6">
                            <table class="table table-condensed">
                              <tr><td>Species</td>
                                <td class="value"><span data-bind="text: plot_summaries()[0].fortypiv"></span></td></tr>
                              <tr><td>Height</td>
                                <td class="value"><span data-bind="text: plot_summaries()[0].stndhgt"></span> m</td></tr>
                              <tr><td>Basal area</td>
                                <td class="value"><span data-bind="text: plot_summaries()[0].baa_ge_3"></span> m<sup>2</sup></td>
                              <tr><td>Trees per hectare</td>
                                <td class="value" data-bind="text: plot_summaries()[0].tph_ge_3"></td></tr>
                              <!--
                              <tr><td>mean diameter</td>
                                <td class="value"><span data-bind="text: plot_summaries()[0].qmda_dom"></span> cm</td>
                              <tr><td>conifer proportion</td>
                                <td class="value" data-bind="text: plot_summaries()[0].bac_prop"></td></tr>
                               -->
                            </table>
                          </div>
                          <div class="span6">
                            <div class="thumbnail">
                              <div id="watermarked-image">
                                <p>Sample</p>
                              </div>
                              <h5><span data-bind="text: plot_summaries()[0].vegclass"></h5>
                            </div>
                          </div>
                        </div>
                        <div class="row-fluid">
                          <div class="btn-group pull-right">
                            <button class="btn" href="#"><i class="icon-repeat"></i> Define Scenarios</button>
                            <a href="#" class="btn"><i class="icon-leaf"></i> Refine Vegetation</a>
                            <a href="#" class="btn" data-bind="click: $parent.showDeleteDialog"><i class="icon-remove"></i> Delete Stand</a>
                            <a href="#" class="btn" data-bind="click: $parent.editStand"><i class="icon-edit"></i> Edit Stand</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  </div>
                  <div data-bind="if: standList().length, visible: standList().length > 10">
                    <div class="pagination">
                      <ul data-bind="foreach: paginationList">
                        <li data-bind="click: $parent.setListIndex, css: { 'active': $parent.listStart() === listIndex, 'disabled': displayIndex === '...' }">
                          <a href="#" data-bind="text: displayIndex, attr: { title: listIndex }"></a>
                        </li>
                      </ul>
                    </div>
                  </div>
                  <div id="stands-none" data-bind="visible: ! standList().length">
                    <h3>Draw your stand</h3>
                    <p>Find your stands on the map by searching for a placename or parcel id.</p>
                    <p>When your property is in view on the map, click the button below to draw the boundaries of your first property.</p>
                    <h3>Add additional information</h3>
                    <p>Then you will be asked to enter some additional information to help describe your property.</p>
                    <div class="pull-right">
                      <button href="#" class="btn" data-bind="click: cancelManageStands">Return to Properties</button>
                      <button href="#" class="btn btn-primary" data-bind="click: addStandStart">Add Stand</button>
                    </div>
                  </div>
                </div>
                <div data-bind="visible: showDrawPanel">
                  <h3>Draw your stand</h3>
                  <p>Starting drawing your stand... etc</p>
                  <div class="pull-right">
                    <button href="#" class="btn" data-bind="click: cancelAddStand">Cancel</button>
                  </div>
                </div>
              </div> <!-- no properties -->
              <div class="row-fluid" data-bind="visible: showStandFormPanel">
                <h3>Additional Information</h3>
                <div id="stands-form-container" class="form-panel"></div>
                <div class="pull-right">
                  <button href="#" class="btn" data-bind="click: cancelAddStand">Cancel</button>
                  <button href="#" class="btn btn-primary" data-bind="click: saveStandForm">Save Stand</button>
                </div>
              </div>
              <div class="modal" id="stand-delete-dialog" style="display:none">
               <div class="modal-header">
                 <a class="close" data-dismiss="modal">×</a>
                 <h3>Delete Stand</h3>
               </div>
               <div class="modal-body">
                 <div data-bind="if: selectedFeature()">
                   Are you sure you want to delete "<span data-bind="text: selectedFeature().name"></span>"?
                 </div>
               </div>
               <div class="modal-footer">
                 <a href="#" class="btn" data-bind="click: closeDialog">cancel</a>
                 <a href="#" class="btn btn-danger" data-bind="click: deleteFeature">Delete Stand</a>
               </div>
             </div>
            </div>
            <!-- end of stand pages -->
            {% else %}
              <div class="well"> 
               <div class="row-fluid">
                <h2>Login</h2>
                <p><em>You currently not logged in to the Forest Scenario Planner.</em></p>
                <ul>
                  <li><a href="{% url 'registration_register' %}" id="register">Register</a></li>
                  <li><a href="{% url 'user_signin' %}" id="signin">Sign In</a></li>                
                </ul> 
              </div><!-- end of no properties -->
            </div>
            {% endif %}
          </div>
          <div class="span6">
            <div class="outermap well">
              <div id="searchbox-container" class="pull-right">
                {% include "common/geosearch.html" %}
              </div>
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- end partial -->
  
    <script type="text/javascript">

    // name space for app
    var app = {
      stands: {},
      properties: {}
    };

    $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
      app.workspace = data;
    });

    app.properties = {
      viewModel: new propertiesViewModel()
    };

    app.onResize = function () {
      $("#map").height($(window).height() - 114);
      map.render('map');
    };
    
    $(document).ready(function () {

      app.properties.viewModel.init()
        .done(function () {
          // apply the viewmodel
          ko.applyBindings(app.properties.viewModel, document.getElementById('property-html'));
          app.onResize();
        })
        .fail(function () {
          map.zoomToExtent(OpenLayers.Bounds.fromArray([-13954802.50397, 5681411.4375898, -13527672.389972, 5939462.8450446]));
          ko.applyBindings(app.viewModel);
        });

      $(window).resize(app.onResize);

      var options = {
        beforeSubmit: function(formData, jqForm, options) {
            var name, file;
            $(formData).each(function () {
                if (this.name === 'new_property_name') {
                     name = this.value;
                } else if (this.name === 'ogrfile') {
                     file = this.value;
                }
            });
            if (!name) {
                $("#upload-propertyname-required").fadeIn();
                return false;
            };
            if (!file) {
                $("#upload-file-required").fadeIn();
                return false;
            };

            $("#uploadProgress").show();
        },
        uploadProgress: function(event, position, total, percentComplete) {
            var percentVal = percentComplete + '%';
            $("#uploadProgress .bar").css('width', percentVal);
        },
        complete: function(xhr) {
            $("#uploadResponse").html(xhr.responseText);
            $("#uploadProgress").hide();
            $("#uploadProgress .bar").css('width', '0%');
            if (xhr.status == 201) {
                // TODO refresh properties list and show proper panels
            }
        }
      }; 
      $('#uploadForm').submit( function () {
          $(this).ajaxSubmit(options); 
          return false; 
      });

    });

    </script>
{% endblock content %}
{% block scripts %}
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
    <script src="{{ MEDIA_URL }}OpenLayers.js"></script>
    {% load compressed %}
    <!-- styles, trees, property, stand .js -->
    {% compressed_js 'application' %}
{% endblock scripts %}
